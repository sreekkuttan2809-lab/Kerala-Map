<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Ward Map - Multi-Stop Navigation</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-fullscreen/2.4.0/Control.FullScreen.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Space Grotesk for the "Spark" vibe -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Map Screen Colors (Google Maps Light Theme) - UNCHANGED */
            --primary-color: #1a73e8; 
            --text-dark: #202124;
            --text-light: #5f6368;
            --surface: #ffffff;
            --bg-gray: #f8f9fa;
            --border: #dadce0;
            --shadow-card: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            
            /* Home Screen Colors (Light Theme) */
            --spark-bg: #f8f9fa;
            --spark-surface: rgba(255, 255, 255, 0.85);
            --spark-text: #202124;
            --spark-accent: #1a73e8; 
            --spark-border: rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f8f9fa; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        .icon-svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- Screens --- */
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
        .screen.active { display: flex; flex-direction: column; z-index: 20; }

        /* --- 3D Background Canvas (Light Mode) --- */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: radial-gradient(circle at center, #ffffff 0%, #e8f0fe 100%);
        }

        /* --- Selector Screen (LIGHT THEME REDESIGN) --- */
        #selectorScreen { 
            align-items: center; 
            justify-content: center; 
            overflow-y: auto; 
            padding: 1rem;
            background: transparent;
            font-family: 'Space Grotesk', sans-serif; /* Tech font */
        }

        .selector-header { 
            text-align: center; /* Centered for better aesthetics */
            margin-bottom: 2.5rem; 
            border-bottom: 1px solid var(--spark-border); 
            padding-bottom: 2rem; 
            position: relative;
        }
        
        .selector-header h1 { 
            font-family: 'Space Grotesk', sans-serif;
            color: var(--spark-accent);
            font-size: 2.8rem; 
            margin-bottom: 0.5rem; 
            font-weight: 700; 
            letter-spacing: -0.03em;
            text-transform: uppercase;
            /* No gradient for cleaner light look, or subtle blue gradient */
            background: linear-gradient(180deg, #1a73e8 0%, #0d47a1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0px 1px 2px rgba(26, 115, 232, 0.2));
        }

        .selector-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--spark-accent);
            opacity: 0.3;
        }
        
        .selector-container { 
            background: var(--spark-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%; 
            max-width: 460px; 
            padding: 3rem 2.5rem; 
            border-radius: 24px; 
            border: 1px solid var(--spark-border);
            z-index: 10;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .selector-section { margin-bottom: 2rem; position: relative; }
        
        #selectorScreen label { 
            display: block; 
            color: #5f6368; 
            font-weight: 600; 
            margin-bottom: 0.8rem; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 2px;
        }
        
        #selectorScreen .selector-input { 
            width: 100%; 
            padding: 12px 0; 
            border: none; 
            border-bottom: 1px solid var(--spark-border);
            border-radius: 0; 
            font-size: 1.1rem; 
            color: var(--spark-text); 
            background: transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        #selectorScreen .selector-input:focus { 
            outline: none; 
            border-bottom-color: var(--spark-accent); 
            background: linear-gradient(to bottom, transparent 95%, rgba(26, 115, 232, 0.05) 100%);
        }
        
        /* Custom Select Arrow Styling workaround */
        #selectorScreen select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Dark arrow for light theme */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23202124%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0 center;
            background-size: 10px;
        }
        
        #selectorScreen option { background-color: white; color: #333; }

        #selectorScreen .type-buttons-container { display: flex; gap: 10px; flex-wrap: wrap; }
        #selectorScreen .type-btn { 
            border: 1px solid var(--spark-border); 
            background: transparent; 
            color: #5f6368; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 500;
            transition: all 0.3s; 
            letter-spacing: 0.5px;
        }
        #selectorScreen .type-btn:hover { border-color: var(--spark-accent); color: var(--spark-accent); background: rgba(26, 115, 232, 0.05); }
        #selectorScreen .type-btn.selected { 
            background: var(--spark-accent); 
            color: white; 
            border-color: var(--spark-accent); 
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);
        }

        #selectorScreen .submit-btn { 
            width: 100%; 
            padding: 18px; 
            background: var(--spark-accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        #selectorScreen .submit-btn:hover:not(:disabled) { 
            background: #1557b0; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }
        #selectorScreen .submit-btn:disabled { 
            background: #e0e0e0; 
            color: #999; 
            cursor: not-allowed; 
            box-shadow: none;
        }

        /* --- Map Screen (UNCHANGED Google Maps Style) --- */
        #mapScreen { background: #f8f9fa; z-index: 20; }
        #mapScreen.active { flex-direction: row; }
        .sidebar { width: 408px; max-width: 100%; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 1000; height: 100%; position: relative; transition: transform 0.3s ease; }
        .sidebar.nav-hidden { transform: translateX(-100%); width: 0; overflow: hidden; opacity: 0; }
        @media (max-width: 600px) {
            #mapScreen.active { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 60vh; order: 2; }
            .sidebar.nav-hidden { transform: translateY(100%); height: 0; }
            #mapContainer { height: 40vh; order: 1; }
            #mapContainer.nav-active { height: 100vh; }
        }

        .transport-bar { background: #fff; padding: 8px 0; display: flex; justify-content: space-around; border-bottom: 1px solid #eee; }
        .mode-btn { display: flex; flex-direction: column; align-items: center; border: none; background: none; cursor: pointer; color: var(--text-light); padding: 8px 16px; border-radius: 40px; transition: background 0.2s; }
        .mode-btn.active { background: #e8f0fe; color: #1967d2; }
        .mode-btn:hover { background: #f1f3f4; }
        .mode-btn .time { font-size: 11px; margin-top: 4px; font-weight: 500; }

        /* Updated Inputs Area */
        .inputs-container { background: #fff; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; max-height: 40vh; overflow-y: auto; }
        #stopsContainer { display: flex; flex-direction: column; gap: 0; border: 1px solid #dadce0; border-radius: 8px; background: white; overflow: hidden; margin-bottom: 10px; }
        .input-row { display: flex; align-items: center; padding: 6px 12px; position: relative; transition: background 0.2s; border-bottom: 1px solid #f1f3f4; }
        .input-row:last-child { border-bottom: none; }
        .input-row.focused { background: #f1f3f4; }
        .directions-input { flex: 1; border: none; padding: 10px 8px; font-size: 14px; outline: none; color: #202124; background: transparent; text-overflow: ellipsis; }
        .stop-indicator { width: 24px; display: flex; flex-direction: column; align-items: center; margin-right: 8px; color: #5f6368; }
        .stop-dot { width: 8px; height: 8px; border: 2px solid #5f6368; border-radius: 50%; }
        .stop-pin { color: #d93025; font-size: 14px; }
        .input-actions { display: flex; gap: 4px; align-items: center; }
        .icon-btn { border: none; background: none; color: #5f6368; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: #e0e0e0; color: #202124; }
        .gps-btn { color: #1a73e8; } 
        .add-stop-btn { display: flex; align-items: center; gap: 8px; background: none; border: none; color: #1a73e8; font-weight: 500; font-size: 14px; padding: 8px 0; cursor: pointer; margin-left: 4px; }
        .add-stop-btn:hover { text-decoration: underline; }

        /* Dropdown */
        .search-dropdown { position: absolute; top: 100%; left: 16px; right: 16px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; z-index: 2000; display: none; border: 1px solid #dadce0; }
        .search-dropdown.active { display: block; }
        .search-result-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f1f3f4; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .search-result-item:hover { background-color: #f1f3f4; }

        /* Map & UI Overlays */
        #mapContainer { flex: 1; height: 100%; width: 100%; z-index: 1; outline: none; transition: height 0.3s; }
        .fab-container { position: absolute; bottom: 24px; right: 16px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; }
        .fab-btn { width: 56px; height: 56px; border-radius: 50%; background: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; color: #1a73e8; transition: all 0.2s; }
        .fab-btn:hover { background: #f8f9fa; }
        .fab-btn.primary { background: #1a73e8; color: white; }

        /* AI Button Style */
        .ai-btn-container {
            padding: 16px;
            background: #f0f7ff;
            border-top: 1px solid #d0e1f7;
            text-align: center;
        }
        .ai-guide-btn {
            background: linear-gradient(135deg, #4285f4, #9b59b6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
            width: 100%;
            justify-content: center;
        }
        .ai-guide-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4); }

        /* AI Modal */
        .ai-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .ai-modal.active { display: flex; }
        .ai-card {
            background: white; width: 90%; max-width: 400px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;
            display: flex; flex-direction: column; max-height: 80vh;
        }
        .ai-header {
            background: linear-gradient(135deg, #4285f4, #9b59b6);
            padding: 16px; color: white; display: flex; justify-content: space-between; align-items: center;
        }
        .ai-header h3 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .ai-close { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.8; }
        .ai-body { flex: 1; padding: 16px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 12px; }
        .ai-message { padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; max-width: 85%; }
        .ai-message.user { background: #e8f0fe; color: #1a73e8; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-message.bot { background: white; border: 1px solid #eee; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-footer { padding: 12px; border-top: 1px solid #eee; background: white; display: flex; gap: 8px; }
        .ai-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .ai-input:focus { border-color: #4285f4; }
        .ai-send { background: #4285f4; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Nav UI */
        .nav-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1500; pointer-events: none; display: none; flex-direction: column; justify-content: space-between; }
        .nav-ui-layer.active { display: flex; }
        #step-banner { background-color: #1a1a1a; color: white; margin: 16px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); pointer-events: auto; transform: translateY(-100px); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; max-width: 600px; width: 90%; align-self: center; }
        #step-banner.active { transform: translateY(0); }
        .maneuver-icon { font-size: 32px; margin-right: 20px; color: #ffffff; width: 40px; text-align: center; }
        .instruction-text { flex: 1; }
        .instruction-main { font-size: 18px; font-weight: 700; }
        .instruction-sub { font-size: 14px; color: #aaa; margin-top: 4px; }
        .distance-badge { font-size: 24px; font-weight: 300; margin-left: 16px; white-space: nowrap; }
        .nav-bottom-container { padding: 20px; display: flex; justify-content: center; pointer-events: auto; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); padding-bottom: 40px; width: 100%; }
        #stats-panel { background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; gap: 20px; align-items: center; }
        .stat-item { display: flex; flex-direction: column; align-items: center; min-width: 60px; }
        .stat-val { font-weight: 700; font-size: 16px; color: #333; }
        .stat-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        #exit-nav-btn { background: #d93025; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .user-puck { background-color: #2563eb; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0.2); width: 20px; height: 20px; }
        
        .error-toast { position: absolute; bottom: 20px; right: 20px; background: #323232; color: white; padding: 16px 24px; border-radius: 8px; font-size: 0.9rem; z-index: 2000; display: none; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.hidden { display: none; }
        .spinner-google { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 3D BACKGROUND CANVAS -->
    <canvas id="bg-canvas"></canvas>

    <!-- HOME SCREEN -->
    <div id="selectorScreen" class="screen active">
        <div class="selector-container">
            <div class="selector-header">
                <h1>Kerala Ward Map</h1>
            </div>
            <div class="selector-section">
                <label>01 // Select District</label>
                <select id="districtSelect" class="selector-input"><option value="">-- Choose District --</option></select>
            </div>
            <div class="selector-section">
                <label>02 // Local Body Type</label>
                <div id="typeButtonsContainer" class="type-buttons-container"><div style="color: rgba(0,0,0,0.4); font-size: 0.8rem; padding: 4px;">Awaiting District Selection...</div></div>
            </div>
            <div class="selector-section">
                <label>03 // Local Body Name</label>
                <select id="bodySelect" class="selector-input" disabled><option value="">-- Select type first --</option></select>
            </div>
            <div class="selector-section">
                <label>04 // Specific Ward (Optional)</label>
                <select id="wardSelect" class="selector-input" disabled><option value="">-- Select body first --</option></select>
            </div>
            <button id="viewMapBtn" class="submit-btn" disabled>Explore Map</button>
        </div>
    </div>

    <!-- MAP SCREEN -->
    <div id="mapScreen" class="screen">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebarPanel">
            <div class="transport-bar">
                <button class="mode-btn active" data-mode="driving" title="Driving"><i class="fa-solid fa-car icon-svg" style="font-size:20px;"></i><span class="time">Best</span></button>
                <button class="mode-btn" data-mode="cycling" title="Two-Wheeler"><i class="fa-solid fa-motorcycle icon-svg" style="font-size:20px;"></i><span class="time">Ride</span></button>
                <button class="mode-btn" data-mode="walking" title="Walking"><i class="fa-solid fa-person-walking icon-svg" style="font-size:20px;"></i><span class="time">Walk</span></button>
                <button class="mode-btn" data-mode="transit" title="Transit (Demo Only)"><i class="fa-solid fa-bus icon-svg" style="font-size:20px;"></i><span class="time">N/A</span></button>
            </div>

            <!-- DYNAMIC INPUTS CONTAINER -->
            <div class="inputs-container">
                <div id="stopsContainer"></div>
                <button class="add-stop-btn" id="addStopBtn"><i class="fa-solid fa-circle-plus"></i> Add destination</button>
            </div>
            
            <!-- SEARCH RESULTS -->
            <div id="searchResults" class="search-dropdown"></div>

            <div class="options-bar"><button class="leave-now-btn">üïí Leave now ‚ñº</button></div>
            <div class="routes-list" id="routesList"><div class="route-card"><div class="route-details" style="text-align:center; padding: 20px;">Calculate route to see details.</div></div></div>
            
            <!-- NEW AI SECTION -->
            <div class="ai-btn-container">
                <button class="ai-guide-btn" id="openAiBtn">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Ask AI Local Guide
                </button>
            </div>
        </div>

        <!-- NAV UI -->
        <div class="nav-ui-layer" id="navUiLayer">
            <div id="step-banner">
                <div class="maneuver-icon" id="maneuver-icon"><i class="fa-solid fa-arrow-up"></i></div>
                <div class="instruction-text"><div class="instruction-main" id="instr-main">Head North</div><div class="instruction-sub" id="instr-sub">Starting Route...</div></div>
                <div class="distance-badge" id="step-dist">0m</div>
            </div>
            <div class="nav-bottom-container">
                <div id="stats-panel">
                    <div class="stat-item"><span class="stat-val" id="total-time" style="color:#188038">0 min</span><span class="stat-label">Arrival</span></div>
                    <div style="width: 1px; height: 20px; background: #ddd;"></div>
                    <div class="stat-item"><span class="stat-val" id="total-dist">0 km</span><span class="stat-label">Distance</span></div>
                    <button id="exit-nav-btn" title="Exit Navigation">‚úï</button>
                </div>
            </div>
        </div>

        <div id="mapContainer"></div>

        <div class="fab-container" id="fabContainer">
            <button class="fab-btn primary" id="navigateBtn" title="Start Multi-Stop Navigation"><i class="fa-solid fa-location-arrow" style="font-size:24px;"></i></button>
            <button id="floatingBackBtn" class="fab-btn" title="Back to Home"><i class="fa-solid fa-arrow-left"></i></button>
        </div>

        <!-- AI CHAT MODAL -->
        <div class="ai-modal" id="aiModal">
            <div class="ai-card">
                <div class="ai-header">
                    <h3><i class="fa-solid fa-robot"></i> Kerala Map Assistant</h3>
                    <button class="ai-close" id="closeAiBtn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="ai-body" id="aiChatBody">
                    <div class="ai-message bot">Hello! I'm your guide for this map. Ask me about the selected ward, tourist spots, or history! ‚ú®</div>
                </div>
                <div class="ai-footer">
                    <input type="text" class="ai-input" id="aiUserInput" placeholder="Ask about this place..." onkeypress="if(event.key==='Enter') sendAiMessage()">
                    <button class="ai-send" onclick="sendAiMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="errorToast" class="error-toast"><div id="errorMsg">Error</div><button style="background:none; border:none; color:#8ab4f8; margin-left:10px; cursor:pointer;" onclick="document.getElementById('errorToast').style.display='none'">CLOSE</button></div>
        <div id="loadingOverlay" class="loading-overlay hidden"><div class="spinner-google"></div><p style="margin-top:1rem; color: var(--text-dark); font-weight:500;">Fetching Data...</p></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-fullscreen/2.4.0/Control.FullScreen.min.js"></script>
    <!-- Three.js for 3D Background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // CONFIG
        const GITHUB_USER = "sreekkuttan2809-lab";
        const GITHUB_REPO = "Kerala-Map";
        const GITHUB_BRANCH = "main";
        const apiKey = ""; // Provided by environment
        
        const districts = ["Thiruvananthapuram", "Kollam", "Pathanamthitta", "Alappuzha", "Kottayam", "Idukki", "Ernakulam", "Thrissur", "Palakkad", "Malappuram", "Kozhikode", "Wayanad", "Kannur", "Kasaragod"];
        const localBodyTypes = [{ id: "G", name: "Grama Panchayat" }, { id: "M", name: "Municipality" }, { id: "C", name: "Corporation" }, { id: "BP", name: "Block Panchayat" }, { id: "DP", name: "District Panchayat" }];
        const mockLocalBodies = { "Thiruvananthapuram": { "C": ["Thiruvananthapuram Corporation"], "M": ["Neyyattinkara", "Nedumangad", "Attingal", "Varkala"] }, "Ernakulam": { "C": ["Kochi Corporation"], "M": ["Aluva", "Kalamassery", "North Paravur", "Tripunithura", "Maradu"] }, "Kozhikode": { "C": ["Kozhikode Corporation"], "M": ["Vadakara", "Koyilandy", "Ramanattukara", "Feroke", "Payyoli", "Koduvally", "Mukkam"] } };

        let appState = {
            district: null, type: null, localBody: null, map: null, geoJsonLayer: null,
            waypoints: [
                { id: 1, text: "Your Location", latlng: null, type: 'gps' },
                { id: 2, text: "", latlng: null, type: 'ward' }
            ],
            activeInputId: 2, 
            transportMode: 'driving',
            allFeatures: [], geoData: null, preSelectedWardName: null,
            isNavigating: false, simulationInterval: null, userPuck: null, navRouteLine: null, routeSteps: [],
            threeRenderer: null
        };

        const els = {
            screens: { selector: document.getElementById('selectorScreen'), map: document.getElementById('mapScreen') },
            districtSelect: document.getElementById('districtSelect'), typeContainer: document.getElementById('typeButtonsContainer'),
            bodySelect: document.getElementById('bodySelect'), wardSelect: document.getElementById('wardSelect'), viewBtn: document.getElementById('viewMapBtn'),
            stopsContainer: document.getElementById('stopsContainer'), addStopBtn: document.getElementById('addStopBtn'),
            searchResults: document.getElementById('searchResults'), routesList: document.getElementById('routesList'),
            floatingBackBtn: document.getElementById('floatingBackBtn'), navigateBtn: document.getElementById('navigateBtn'),
            sidebarPanel: document.getElementById('sidebarPanel'), mapContainer: document.getElementById('mapContainer'),
            fabContainer: document.getElementById('fabContainer'), navUiLayer: document.getElementById('navUiLayer'), stepBanner: document.getElementById('step-banner'), exitNavBtn: document.getElementById('exit-nav-btn'),
            loading: document.getElementById('loadingOverlay'), errorToast: document.getElementById('errorToast'), errorMsg: document.getElementById('errorMsg'),
            bgCanvas: document.getElementById('bg-canvas'),
            // AI
            openAiBtn: document.getElementById('openAiBtn'), closeAiBtn: document.getElementById('closeAiBtn'), aiModal: document.getElementById('aiModal'),
            aiChatBody: document.getElementById('aiChatBody'), aiUserInput: document.getElementById('aiUserInput')
        };

        function init() {
            districts.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; els.districtSelect.appendChild(opt); });
            init3DBackground();
            setupEvents();
        }

        // --- 3D BACKGROUND LOGIC (LIGHT THEME + 50% SPHERE + SNOW) ---
        function init3DBackground() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: els.bgCanvas, alpha: true, antialias: true });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            appState.threeRenderer = renderer;

            // 1. Wireframe Globe (Blue on White) - 50% OPACITY
            const geometry = new THREE.IcosahedronGeometry(10, 2);
            const material = new THREE.MeshBasicMaterial({ color: 0x3b82f6, wireframe: true, transparent: true, opacity: 0.5 });
            const globe = new THREE.Mesh(geometry, material);
            scene.add(globe);

            // 2. Inner Core (Lighter Blue)
            const coreGeom = new THREE.IcosahedronGeometry(9, 1);
            const coreMat = new THREE.MeshBasicMaterial({ color: 0x60a5fa, wireframe: true, transparent: true, opacity: 0.3 });
            const core = new THREE.Mesh(coreGeom, coreMat);
            scene.add(core);

            // 3. Particles (SNOWFALLING EFFECT)
            // Use blueish color for snow to be visible on white bg
            const particlesGeom = new THREE.BufferGeometry();
            const particlesCount = 700;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i=0; i<particlesCount*3; i++) {
                posArray[i] = (Math.random() - 0.5) * 40; // Spread
            }
            particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.08, color: 0x1a73e8, transparent: true, opacity: 0.6 });
            const particlesMesh = new THREE.Points(particlesGeom, particlesMat);
            scene.add(particlesMesh);

            camera.position.z = 18;

            // Mouse Interaction
            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });

            // Animation Loop
            let animateId;
            const animate = () => {
                animateId = requestAnimationFrame(animate);
                
                globe.rotation.y += 0.002;
                globe.rotation.x += 0.001;
                core.rotation.y -= 0.001;
                
                // Snowfalling: Move particles down
                const positions = particlesGeom.attributes.position.array;
                for(let i = 1; i < particlesCount * 3; i += 3) { // y is at index 1, 4, 7...
                    positions[i] -= 0.05; // Fall speed
                    if (positions[i] < -20) {
                        positions[i] = 20; // Reset to top
                    }
                }
                particlesGeom.attributes.position.needsUpdate = true;

                // Subtle Mouse Parallax
                globe.rotation.x += mouseY * 0.001;
                globe.rotation.y += mouseX * 0.001;

                renderer.render(scene, camera);
            };
            animate();

            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            appState.pause3D = () => cancelAnimationFrame(animateId);
            appState.resume3D = () => animate();
        }

        function setupEvents() {
            els.districtSelect.addEventListener('change', e => { appState.district = e.target.value; appState.type = null; appState.localBody = null; renderTypeButtons(); els.bodySelect.innerHTML = '<option value="">-- Select type first --</option>'; els.bodySelect.disabled = true; els.wardSelect.innerHTML = '<option value="">-- Select body first --</option>'; els.wardSelect.disabled = true; els.viewBtn.disabled = true; });
            els.bodySelect.addEventListener('change', async e => {
                appState.localBody = e.target.value; appState.geoData = null;
                els.wardSelect.innerHTML = '<option>Loading Wards...</option>'; els.wardSelect.disabled = true; els.viewBtn.disabled = true;
                try {
                    const data = await fetchGeoJsonFromRepo(appState.district, appState.localBody);
                    appState.geoData = data; populateWardDropdown(data); els.viewBtn.disabled = false;
                } catch (err) { els.wardSelect.innerHTML = '<option>Error loading wards</option>'; els.viewBtn.disabled = false; }
            });
            els.wardSelect.addEventListener('change', e => { appState.preSelectedWardName = e.target.value; });
            
            // VIEW MAP (Transitions)
            els.viewBtn.addEventListener('click', () => {
                if(appState.pause3D) appState.pause3D(); 
                els.bgCanvas.style.display = 'none'; 
                
                switchScreen('map'); initMap();
                if (appState.geoData) {
                    renderMapWithData(appState.geoData);
                    if (appState.preSelectedWardName) {
                        const found = appState.allFeatures.find(f => getWardName(f.feature.properties) === appState.preSelectedWardName);
                        if (found) { selectWard(found.layer); updateWaypoint(2, found.layer); }
                    }
                } else fetchData();
                renderInputs(); 
            });

            // BACK TO HOME (Transitions)
            els.floatingBackBtn.addEventListener('click', () => {
                switchScreen('selector');
                els.bgCanvas.style.display = 'block'; 
                if(appState.resume3D) appState.resume3D(); 
            });

            els.navigateBtn.addEventListener('click', startMultiStopNavigation);
            els.exitNavBtn.addEventListener('click', stopNavigationDemo);
            els.addStopBtn.addEventListener('click', () => {
                appState.waypoints.push({ id: Date.now(), text: "", latlng: null, type: 'ward' });
                renderInputs();
            });
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.getAttribute('data-mode');
                    if (mode === 'transit') { alert("Public Transit routing is not available in this demo. Please try Driving or Walking."); return; }
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    appState.transportMode = mode;
                });
            });

            // AI UI Events
            els.openAiBtn.addEventListener('click', () => els.aiModal.classList.add('active'));
            els.closeAiBtn.addEventListener('click', () => els.aiModal.classList.remove('active'));

            document.addEventListener('click', (e) => { if (!els.searchResults.contains(e.target)) els.searchResults.classList.remove('active'); });
        }

        // --- GEMINI AI INTEGRATION ---
        async function sendAiMessage() {
            const input = els.aiUserInput.value.trim();
            if (!input) return;

            // 1. Add User Message
            addMessageToChat(input, 'user');
            els.aiUserInput.value = '';

            // 2. Prepare Context
            const context = `
                You are a helpful local guide for Kerala, India.
                The user is exploring the map application.
                Current Context:
                - District: ${appState.district || 'Not selected'}
                - Local Body: ${appState.localBody || 'Not selected'}
                - Selected Ward: ${appState.waypoints.find(w => w.type === 'ward')?.text || 'None'}
                
                Answer the user's question briefly and helpfully about this location.
                If they ask about the app, explain it helps visualize ward boundaries and navigate.
            `;

            // 3. Call Gemini
            try {
                // Show typing indicator
                const typingId = addMessageToChat("Thinking...", 'bot');
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: context + "\nUser Question: " + input }]
                        }]
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                const typingElem = document.getElementById(typingId);
                if(typingElem) typingElem.remove();

                if (data.candidates && data.candidates[0].content) {
                    const reply = data.candidates[0].content.parts[0].text;
                    addMessageToChat(reply, 'bot');
                } else {
                    addMessageToChat("Sorry, I couldn't connect to the AI service right now.", 'bot');
                }
            } catch (e) {
                console.error(e);
                addMessageToChat("Error connecting to AI.", 'bot');
            }
        }

        function addMessageToChat(text, sender) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.className = `ai-message ${sender}`;
            div.id = id;
            div.innerText = text;
            els.aiChatBody.appendChild(div);
            els.aiChatBody.scrollTop = els.aiChatBody.scrollHeight;
            return id;
        }

        // --- DYNAMIC INPUTS ---
        function renderInputs() {
            els.stopsContainer.innerHTML = '';
            
            appState.waypoints.forEach((wp, index) => {
                const row = document.createElement('div');
                row.className = `input-row ${appState.activeInputId === wp.id ? 'focused' : ''}`;
                let icon = '<div class="stop-dot"></div>';
                if(index === appState.waypoints.length - 1) icon = '<i class="fa-solid fa-location-dot stop-pin"></i>';
                
                row.innerHTML = `
                    <div class="stop-indicator">${icon}</div>
                    <input type="text" class="directions-input" placeholder="${index === 0 ? 'Start location' : 'Add destination'}" value="${wp.text}" readonly>
                    <div class="input-actions">
                        <button class="icon-btn gps-btn" title="Use Current Location" onclick="setWaypointToGPS(${wp.id})"><i class="fa-solid fa-crosshairs"></i></button>
                        ${appState.waypoints.length > 2 ? `<button class="icon-btn" title="Remove" onclick="removeWaypoint(${index})"><i class="fa-solid fa-xmark"></i></button>` : ''}
                    </div>
                `;
                
                const input = row.querySelector('input');
                input.addEventListener('click', () => {
                    appState.activeInputId = wp.id;
                    renderInputs(); 
                    if(wp.type !== 'gps') showWardSearch(input);
                });
                els.stopsContainer.appendChild(row);
            });
        }

        function removeWaypoint(index) {
            appState.waypoints.splice(index, 1);
            renderInputs();
        }

        function updateWaypoint(id, layer) {
            const wp = appState.waypoints.find(w => w.id === id);
            if(wp && layer) {
                const name = getWardName(layer.feature.properties);
                wp.text = name;
                wp.latlng = layer.getBounds().getCenter();
                wp.type = 'ward';
                renderInputs();
            }
        }

        function setWaypointToGPS(id) {
            els.loading.classList.remove('hidden');
            if (!navigator.geolocation) { alert("Geolocation not supported"); els.loading.classList.add('hidden'); return; }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                    const wp = appState.waypoints.find(w => w.id === id);
                    if(wp) {
                        wp.text = "Your Location";
                        wp.latlng = latlng;
                        wp.type = 'gps';
                        if(appState.startMarker) appState.map.removeLayer(appState.startMarker);
                        appState.startMarker = L.marker(latlng, { icon: L.divIcon({ className: 'custom-start-icon', html: '<div style="background-color:#1a73e8; width:14px; height:14px; border-radius:50%; border:2px solid white;"></div>' }) }).addTo(appState.map);
                        appState.map.setView(latlng, 14);
                        renderInputs();
                    }
                    els.loading.classList.add('hidden');
                },
                () => { alert("Location access denied"); els.loading.classList.add('hidden'); }
            );
        }

        function showWardSearch(inputElem) {
            const matches = appState.allFeatures.slice(0, 10);
            renderSearchResults(matches, inputElem);
            inputElem.removeAttribute('readonly');
            inputElem.focus();
            inputElem.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                const filtered = appState.allFeatures.filter(f => {
                    const name = getWardName(f.feature.properties);
                    return name.toLowerCase().includes(term);
                }).slice(0, 10);
                renderSearchResults(filtered, inputElem);
            });
        }

        function renderSearchResults(matches, inputElem) {
            els.searchResults.innerHTML = '';
            if(matches.length > 0) {
                matches.forEach(match => {
                    const name = getWardName(match.feature.properties);
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `<span style="color:#d93025">üìç</span> ${name}`;
                    div.onclick = () => {
                        selectWard(match.layer);
                        updateWaypoint(appState.activeInputId, match.layer);
                        els.searchResults.classList.remove('active');
                        inputElem.setAttribute('readonly', true);
                    };
                    els.searchResults.appendChild(div);
                });
                els.searchResults.classList.add('active');
                els.searchResults.style.top = (inputElem.parentElement.offsetTop + inputElem.parentElement.offsetHeight + 10) + 'px';
            } else { els.searchResults.classList.remove('active'); }
        }

        function getWardName(props) { return props.wardName || props.WARD_NAME || props.Name || `Ward ${props.wardNo}`; }

        // --- MAP & FETCHING ---
        function populateWardDropdown(data) {
            els.wardSelect.innerHTML = '<option value="">-- Optional: Select a specific ward --</option>'; els.wardSelect.disabled = false;
            let wards = [];
            data.features.forEach(f => { wards.push({ name: getWardName(f.properties), num: parseInt(f.properties.wardNo || 0) || 9999 }); });
            wards.sort((a, b) => a.num - b.num);
            wards.forEach(w => { const opt = document.createElement('option'); opt.value = w.name; opt.textContent = w.name; els.wardSelect.appendChild(opt); });
        }

        async function fetchGeoJsonFromRepo(district, localBody) {
             const cleanDistrict = encodeURIComponent(district); const rawBody = localBody;
             const variations = [`${encodeURIComponent(rawBody)}.json`, `${encodeURIComponent(rawBody)}.geojson`, `${rawBody.replace(/ /g, '_')}.json`, `${rawBody.replace(/ /g, '_')}.geojson`];
             for (const fileName of variations) {
                 const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${cleanDistrict}/${fileName}`;
                 try { const res = await fetch(url); if (res.ok) return await res.json(); } catch (e) {}
             }
             throw new Error("File not found");
        }

        function renderTypeButtons() { els.typeContainer.innerHTML = ''; if(!appState.district) return; localBodyTypes.forEach(t => { const btn = document.createElement('button'); btn.className = 'type-btn'; btn.textContent = t.name; btn.onclick = () => { document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); appState.type = t.id; populateBodies(); }; els.typeContainer.appendChild(btn); }); }
        function populateBodies() { els.bodySelect.innerHTML = '<option value="">-- Select Local Body --</option>'; els.bodySelect.disabled = false; let list = (mockLocalBodies[appState.district] && mockLocalBodies[appState.district][appState.type]) ? mockLocalBodies[appState.district][appState.type] : [`${appState.district} Body 1`, `${appState.district} Body 2`]; list.forEach(item => { const opt = document.createElement('option'); opt.value = item; opt.textContent = item; els.bodySelect.appendChild(opt); }); }
        function switchScreen(name) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); els.screens[name].classList.add('active'); els.searchResults.classList.remove('active'); if(name === 'map' && appState.map) setTimeout(() => appState.map.invalidateSize(), 200); }
        function initMap() { if(appState.map) return; appState.map = L.map('mapContainer', { zoomControl: false }).setView([10.8505, 76.2711], 8); L.control.zoom({ position: 'bottomright' }).addTo(appState.map); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(appState.map); }
        
        async function fetchData() {
            els.loading.classList.remove('hidden');
            try {
                const data = await fetchGeoJsonFromRepo(appState.district, appState.localBody);
                appState.geoData = data; renderMapWithData(data);
            } catch(e) { els.errorMsg.innerHTML = `<b>Map Data Missing</b><br>${e.message}`; els.errorToast.style.display = 'block'; } finally { els.loading.classList.add('hidden'); }
        }

        function renderMapWithData(data) {
            appState.allFeatures = [];
            if(appState.geoJsonLayer) { appState.map.removeLayer(appState.geoJsonLayer); appState.geoJsonLayer = null; }
            appState.geoJsonLayer = L.geoJSON(data, {
                style: { color: "#1a73e8", weight: 1, opacity: 1, fillColor: "#1a73e8", fillOpacity: 0.1 },
                onEachFeature: (feature, layer) => {
                    appState.allFeatures.push({ feature, layer });
                    layer.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        selectWard(layer);
                        updateWaypoint(appState.activeInputId, layer);
                    });
                }
            }).addTo(appState.map);
            appState.map.fitBounds(appState.geoJsonLayer.getBounds(), { padding: [20, 20] });
        }

        function selectWard(layer) {
            if(appState.selectedLayer) appState.geoJsonLayer.resetStyle(appState.selectedLayer);
            appState.selectedLayer = layer;
            layer.setStyle({ weight: 3, color: '#d93025', fillOpacity: 0.4 }); layer.bringToFront();
            appState.map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 16 });
        }

        // --- NAVIGATION LOGIC ---
        async function startMultiStopNavigation() {
            const stops = appState.waypoints.filter(w => w.latlng);
            if (stops.length < 2) { alert("Please set at least a start and end location"); return; }

            appState.isNavigating = true;
            els.sidebarPanel.classList.add('nav-hidden');
            els.mapContainer.classList.add('nav-active');
            els.fabContainer.style.display = 'none';
            els.navUiLayer.classList.add('active');
            els.stepBanner.classList.add('active');
            document.getElementById('instr-sub').innerText = `Calculating ${appState.transportMode} route...`;

            try {
                // Construct OSRM URL with profile
                const coords = stops.map(s => `${s.latlng.lng},${s.latlng.lat}`).join(';');
                let profile = 'driving';
                if (appState.transportMode === 'walking') profile = 'walking';
                if (appState.transportMode === 'cycling') profile = 'cycling';

                const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=full&geometries=geojson&steps=true`;
                
                const response = await fetch(url);
                const json = await response.json();
                if (json.code !== 'Ok') throw new Error("Route not found");

                const route = json.routes[0];
                const coordinates = route.geometry.coordinates.map(c => L.latLng(c[1], c[0]));
                
                appState.routeSteps = [];
                route.legs.forEach(leg => appState.routeSteps.push(...leg.steps));

                if(appState.navRouteLine) appState.map.removeLayer(appState.navRouteLine);
                appState.navRouteLine = L.polyline(coordinates, { color: '#4285F4', weight: 8, opacity: 0.8 }).addTo(appState.map);

                animateAlongRoute(coordinates);

            } catch (e) {
                console.error(e);
                alert("Navigation Error: " + e.message);
                stopNavigationDemo();
            }
        }

        function animateAlongRoute(routePoints) {
            const start = routePoints[0];
            if(appState.userPuck) appState.map.removeLayer(appState.userPuck);
            const icon = L.divIcon({ className: 'user-puck', iconSize: [20, 20] });
            appState.userPuck = L.marker(start, { icon: icon, zIndexOffset: 1000 }).addTo(appState.map);

            let idx = 0;
            const totalPoints = routePoints.length;
            
            if(appState.simulationInterval) clearInterval(appState.simulationInterval);
            appState.simulationInterval = setInterval(() => {
                if(idx >= totalPoints - 1) { 
                    document.getElementById('instr-main').innerText = "Arrived";
                    document.getElementById('instr-sub').innerText = "Destination reached";
                    setTimeout(stopNavigationDemo, 3000); 
                    return; 
                }
                const p1 = routePoints[Math.floor(idx)];
                appState.userPuck.setLatLng(p1);
                appState.map.flyTo(p1, 18, { animate: false });
                
                const remaining = routePoints.slice(Math.floor(idx)).reduce((acc, curr, i, arr) => (i === 0 ? 0 : acc + arr[i-1].distanceTo(curr)), 0);
                document.getElementById('step-dist').innerText = Math.round(remaining) + "m";
                document.getElementById('total-dist').innerText = (remaining/1000).toFixed(1) + " km";
                document.getElementById('total-time').innerText = Math.ceil(remaining/500) + " min";
                
                updateInstructions(p1);
                idx += 0.5;
            }, 50);
        }

        function updateInstructions(currentLatLng) {
            let closestStep = null, minD = Infinity;
            for(const step of appState.routeSteps) {
                const stepLoc = L.latLng(step.maneuver.location[1], step.maneuver.location[0]);
                const d = currentLatLng.distanceTo(stepLoc);
                if (d < minD) { minD = d; closestStep = step; }
            }
            if (closestStep) {
                const m = closestStep.maneuver;
                let text = m.type;
                if (m.modifier) text += " " + m.modifier;
                let icon = "fa-arrow-up", rot = "";
                if (text.includes("left")) icon = "fa-arrow-left"; else if (text.includes("right")) icon = "fa-arrow-right";
                if (m.modifier?.includes("slight")) rot = m.modifier.includes("right") ? "rotate(45deg)" : "rotate(-45deg)";
                
                document.getElementById('maneuver-icon').innerHTML = `<i class="fa-solid ${icon}" style="transform:${rot}"></i>`;
                document.getElementById('instr-main').innerText = text.replace(/-/g, ' ').toUpperCase();
                document.getElementById('instr-sub').innerText = closestStep.name || "Road";
            }
        }

        function stopNavigationDemo() {
            appState.isNavigating = false;
            if(appState.simulationInterval) clearInterval(appState.simulationInterval);
            els.sidebarPanel.classList.remove('nav-hidden'); els.mapContainer.classList.remove('nav-active'); els.fabContainer.style.display = 'flex'; els.navUiLayer.classList.remove('active'); els.stepBanner.classList.remove('active');
            if(appState.navRouteLine) appState.map.removeLayer(appState.navRouteLine);
            if(appState.userPuck) appState.map.removeLayer(appState.userPuck);
            if(appState.selectedLayer) appState.map.fitBounds(appState.selectedLayer.getBounds());
        }

        init();
    </script>
</body>
</html>
